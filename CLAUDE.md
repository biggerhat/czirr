# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Family management app (calendar, chores, recipes, meal plans, budgeting, lists, contacts) built with Laravel 12, Inertia.js, and Vue 3 + TypeScript. UI uses shadcn-vue (reka-ui v2.8.0). Auth via Laravel Fortify with Spatie Laravel Permission for role-based access.

## Commands

```bash
# Development (starts server, queue, logs, and Vite concurrently)
composer dev

# Run tests
./vendor/bin/pest
./vendor/bin/pest tests/Feature/CalendarTest.php          # single file
./vendor/bin/pest --filter=test_name                       # single test

# Linting
composer lint              # PHP (Pint)
npm run lint               # ESLint (JS/TS/Vue)
npm run format             # Prettier

# Build
npm run build              # Production build (includes PWA assets)

# Migrations
php artisan migrate
```

## Architecture

### Multi-Family Ownership Model

All resources are scoped to a "family owner" user. The `User` model has key methods:
- `familyOwnerId()` — returns the owning user's ID (self for owners, linked user's owner for members)
- `familyOwner()` — returns the owning User instance
- `linkedFamilyMember()` — returns the FamilyMember record linking this user into another family

**Always scope resource queries with `$user->familyOwnerId()`**, never assume `$user->id` owns resources. When creating resources, use `$user->familyOwner()->chores()->create(...)`.

### Inertia Data Flow

Controllers return `Inertia::render('PageName', [...props])`. The `HandleInertiaRequests` middleware shares global props: `auth.user`, `permissions` (array of permission names), `familyRole`, `userRole`, `sidebarOpen`.

Vue pages live in `resources/js/pages/` and receive props from their controller. No separate API routes for main flows.

### Permission System

Uses Spatie Laravel Permission. Format: `resource.action` (e.g., `chores.create`, `budgeting.view`).
- Routes: `->middleware('permission:chores.create')`
- Controllers: `$user->can('chores.edit')`
- Frontend: permissions array is shared via Inertia props

The `family` middleware alias (`EnsureFamilyMember`) ensures the user belongs to a family before accessing protected routes.

### Frontend Structure

- Pages: `resources/js/pages/{Feature}/` — Inertia page components
- UI components: `resources/js/components/ui/` — shadcn-vue primitives
- Feature components: `resources/js/components/{feature}/` — feature-specific
- Types: `resources/js/types/` — TypeScript interfaces
- Composables: `resources/js/composables/`
- Route helpers: `resources/js/wayfinder/` — generated by `@laravel/vite-plugin-wayfinder`

### Service Layer

Business logic for complex features lives in `app/Services/` (e.g., `ChoreScoreService` for gamification scoring, `BudgetService`, `RecurringEventService`).

## Key Gotchas

**reka-ui Checkbox**: Uses `modelValue`, NOT `checked`. Using `:checked` silently fails — the prop falls through as an HTML attribute. Correct: `v-model="val"` or `:model-value="val"` + `@update:model-value="handler"`.

**Pre-existing TS errors** (not introduced by us):
- `TwoFactorSetupModal.vue(271)`: Property 'code' does not exist on type 'string'
- `AuthCardLayout.vue(11)` / `AuthSplitLayout.vue(4)`: Module '@/routes' has no exported member 'home'

**Node.js version**: Node 19.9.0 is installed but Vite 7.3.1 requires 20.19+. Build may fail — this is pre-existing.

## Code Style

- PHP: Laravel Pint (laravel preset), enforced in CI
- JS/TS/Vue: ESLint (Vue 3 essential + TypeScript) + Prettier (single quotes, 4-space indent, 80-char width)
- Import sorting enforced: builtin → external → internal → parent → sibling → index
- Type-only imports must use `import type` syntax
